<!DOCTYPE html>
<html lang = "en">
  <head>
    <!-- Preload theme to avoid flash -->
    <script>
      (function () {
        try {
          const saved = localStorage.getItem("theme");
          const wantsDark = saved === "dark"; // only dark if saved
          if (wantsDark) document.documentElement.classList.add("dark");
        } catch (e) {}
      })();
    </script>

    <meta charset = "UTF-8" />
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0" />
    <title>Pietro Rebecchi's Archive</title>

    <!-- Tailwind CSS -->
    <link href = "https://cdn.jsdelivr.net/npm/tailwindcss@2.2.17/dist/tailwind.min.css" rel = "stylesheet" />

    <!-- Base font -->
    <style>
      body { font-family: "SF Mono", "Apple System UI Mono", Menlo, Monaco, Consolas, "Courier New", monospace; }
    </style>

    <!-- Light/Dark theme + tokens (match index.html) -->
    <style>
      :root { color-scheme: light; }
      .dark { color-scheme: dark; }

      :root {
        --bg: #ffffff;      /* light page bg */
        --text: #000000;    /* light text */
        --muted: #4b5563;   /* light secondary */
        --card: #f3f4f6;    /* light panels */
        --accent: #1e39d0;  /* single blue accent */
      }
      .dark {
        --bg: #0b1220;      /* unified dark background */
        --text: #e6ecf7;    /* soft near-white */
        --muted: #a0aec0;   /* desaturated blue-gray */
        --card: #101a2b;    /* use for optional cards if needed */
        --accent: #1e39d0;  /* same accent */
      }

      html, body, nav, footer, .bg-white, .text-black, .text-gray-600, a {
        transition: background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease;
      }

      html, body { background-color: var(--bg); color: var(--text); }

      /* Unify generic white surfaces in dark */
      .dark .bg-white { background-color: var(--bg) !important; }

      /* Navbar + divider line ("shade") */
      nav, footer { background-color: var(--bg); color: var(--text); }
      nav { border-bottom: 1px solid rgba(0, 0, 0, .08); }
      .dark nav { border-bottom: 1px solid rgba(255, 255, 255, .08) !important; }

      /* Text utilities in dark */
      .dark .text-black { color: var(--text) !important; }
      .dark .text-gray-600 { color: var(--muted) !important; }

      /* Links use the single accent */
      a { color: var(--accent); }
      a:hover { opacity: .9; }
      .dark a { color: var(--accent) !important; }

      /* Post content typography */
      #post-content h1 { font-size: 2rem; font-weight: 600; margin-bottom: 1rem; }
      #post-content h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; }
      #post-content h3 { font-size: 1.15rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: .75rem; }
      #post-content p { margin-bottom: 1rem; }
      #post-content ul { padding-left: 1.5rem; list-style-type: disc; margin-bottom: 1rem; }
      #post-content a { text-decoration: underline; }

      /* Tag chips: FILLED, no # */
      .tag-chip {
        background-color: rgba(30, 57, 208, .12);  /* accent tint */
        color: var(--accent);
        display: inline-flex;
        align-items: center;
        padding: .25rem .5rem;
        font-size: .875rem;
        border-radius: .375rem;
        margin-right: .5rem;
        border: 0;
      }
      .dark .tag-chip {
        background-color: rgba(30, 57, 208, .20);  /* a touch stronger in dark */
        color: var(--accent);
      }
    </style>

    <!-- KaTeX for rendering math formulas -->
    <link rel = "stylesheet" href = "https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" />
    <script defer src = "https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <script defer src = "https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"
            onload = "renderMathInElement(document.body);"></script>
  </head>

  <body>
    <!-- Navigation Menu -->
    <nav class = "navigation menu bg-white p-5 shadow" style = "background-color: white;">
      <div class = "container menu container mx-auto flex justify-end items-center">
        <a href = "index.html" class = "text-black hover:text-gray-500 px-3 transform transition duration-200 hover:scale-105">Home</a>
        <a href = "archive.html" class = "text-black hover:text-gray-500 px-3 transform transition duration-200 hover:scale-105">Archive</a>
        <a href = "CV.pdf" class = "text-black hover:text-gray-500 px-3 transform transition duration-200 hover:scale-105">CV</a>

        <!-- Theme toggle button -->
        <button
          id = "theme-toggle"
          class = "ml-3 rounded-full p-2 hover:scale-105 transform transition duration-200 focus:outline-none"
          aria-label = "Toggle dark mode"
          aria-pressed = "false"
          title = "Toggle dark mode"
        >
          🌙
        </button>
      </div>
    </nav>

    <!-- Content -->
    <div class = "container mx-auto px-4 sm:px-4 md:px-12 py-8">
      <div class = "bg-white rounded-lg p-8 md:px-24 px-8">
        <!-- Archive List Mode -->
        <div id = "archive-list">
          <h1 class = "text-3xl font-semibold mb-6 text-center">Archive</h1>
          <ul class = "space-y-4">
            <!-- Post 1 -->
            <li>
              <a href = "archive.html?post=posts/post1" class = "block">
                <span style = "color: var(--accent);" class = "text-md">Genesis: Why, What & How</span>
                <p class = "text-gray-600 text-sm">The genesis of this blog</p>
                <p class = "text-gray-600 text-sm">Date: 05/07/2025</p>
                <p class = "text-gray-600 text-sm">Blog</p>
              </a>
            </li>
            <!-- Post 2 -->
            <li>
              <a href = "archive.html?post=posts/post2" class = "block">
                <span style = "color: var(--accent);" class = "text-md">Studying in Copenhagen</span>
                <p class = "text-gray-600 text-sm">My experience studying in Copenhagen</p>
                <p class = "text-gray-600 text-sm">Date: 08/07/2025</p>
                <p class = "text-gray-600 text-sm">Denmark</p>
              </a>
            </li>
          </ul>
        </div>

        <!-- Post View Mode (hidden by default) -->
        <div id = "post-view" style = "display: none;">
          <h1 id = "post-title" class = "text-3xl font-semibold mb-6 text-center"></h1>
          <div id = "post-content" class = "text-gray-600 mx-auto max-w-4xl px-4 text-md" style = "text-align: justify;"></div>
          <div id = "back-link" class = "mt-4 text-center"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class = "bg-white fixed bottom-0 left-0 w-full text-black text-sm text-center">
      &copy; 2025 Pietro Rebecchi
    </footer>

    <!-- Libraries -->
    <script src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- App logic -->
    <script>
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function parseFrontMatter(text) {
        if (text.startsWith('---')) {
          const end = text.indexOf('---', 3);
          if (end !== -1) {
            const frontMatter = text.substring(3, end).trim();
            const content = text.substring(end + 3).trim();
            const metadata = {};
            frontMatter.split('\n').forEach(line => {
              const parts = line.split(':');
              if (parts.length >= 2) {
                const key = parts[0].trim();
                const value = parts.slice(1).join(':').trim();
                metadata[key] = value;
              }
            });
            return { metadata, content };
          }
        }
        return { metadata: {}, content: text };
      }

      function appendBackLink(source) {
        const backLinkDiv = document.getElementById("back-link");
        backLinkDiv.innerHTML = "";
        const backLink = document.createElement("a");
        backLink.className = "inline-block text-black hover:text-gray-600 px-3 transform transition duration-200 hover:scale-105";
        if (source === "index") {
          backLink.href = "index.html";
          backLink.innerHTML = "&larr; Back to Home";
        } else {
          backLink.href = "archive.html";
          backLink.innerHTML = "&larr; Back to Archive";
        }
        backLinkDiv.appendChild(backLink);
      }

      const postName = getQueryParam("post");
      if (postName) {
        const source = getQueryParam("source");
        document.getElementById("archive-list").style.display = "none";
        document.getElementById("post-view").style.display = "block";

        fetch(`${postName}.md`)
          .then(response => {
            if (!response.ok) throw new Error("Post not found");
            return response.text();
          })
          .then(text => {
            const { metadata, content } = parseFrontMatter(text);
            let headerHtml = "";

            if (metadata.date) {
              headerHtml += `<p class = "text-gray-600 text-sm">Date: ${metadata.date}</p>`;
            }
            if (metadata.tags) {
              const tagList = metadata.tags.split(',').map(tag => tag.trim());
              const tagHtml = tagList.map(tag =>
                `<span class = "tag-chip">${tag}</span>`
              ).join('');
              headerHtml += `<div class = "mt-2 mb-2">${tagHtml}</div>`;
            }

            document.getElementById("post-title").innerText =
              metadata.title || postName.replace(/post/i, "Blog Post ");
            document.getElementById("post-content").innerHTML =
              headerHtml + marked.parse(content);

            renderMathInElement(document.getElementById("post-content"), {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false }
              ]
            });

            appendBackLink(source);
          })
          .catch(error => {
            console.error("Error fetching the markdown file:", error);
            document.getElementById("post-content").innerHTML = "<p>Error loading post :(</p>";
            appendBackLink(getQueryParam("source"));
          });
      }
    </script>

    <!-- Theme toggle logic (match index.html) -->
    <script>
      (function () {
        const STORAGE_KEY = "theme";
        const btn = document.getElementById("theme-toggle");

        function applyTheme(theme) {
          const root = document.documentElement;
          const dark = theme === "dark";
          root.classList.toggle("dark", dark);
          btn.setAttribute("aria-pressed", dark ? "true" : "false");
          btn.textContent = dark ? "☀️" : "🌙";
          btn.title = dark ? "Switch to light mode" : "Switch to dark mode";
          try {
            let meta = document.querySelector('meta[name="theme-color"]');
            if (!meta) {
              meta = document.createElement("meta");
              meta.setAttribute("name", "theme-color");
              document.head.appendChild(meta);
            }
            meta.setAttribute("content", dark ? "#0b1220" : "#ffffff");
          } catch (e) {}
        }

        (function init() {
          let theme = localStorage.getItem(STORAGE_KEY);
          if (!theme) {
            theme = "light"; // always default to light
          }
          applyTheme(theme);

          const mql = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
          if (mql && mql.addEventListener) {
            mql.addEventListener("change", (e) => {
              if (!localStorage.getItem(STORAGE_KEY)) {
                applyTheme("light"); // keep light if no saved theme
              }
            });
          }
        })();

        btn.addEventListener("click", () => {
          const current = document.documentElement.classList.contains("dark") ? "dark" : "light";
          const next = current === "dark" ? "light" : "dark";
          localStorage.setItem(STORAGE_KEY, next);
          applyTheme(next);
        });
      })();
    </script>
  </body>
</html>